#!/usr/bin/env python3
"""
λ¦¬ν©ν† λ§λ μΏ ν΅ μƒν’ API ν΄λΌμ΄μ–ΈνΈ ν…μ¤νΈ
"""

import sys
import os

# ν”„λ΅μ νΈ λ£¨νΈλ¥Ό Python κ²½λ΅μ— μ¶”κ°€
current_dir = os.path.dirname(os.path.abspath(__file__))
project_root = os.path.join(current_dir, '..', '..', '..')
sys.path.insert(0, project_root)

def test_import_compatibility():
    """κΈ°μ΅΄ νΈν™μ„± ν…μ¤νΈ"""
    print("π§ κΈ°μ΅΄ import νΈν™μ„± ν…μ¤νΈ...")
    
    try:
        # κΈ°μ΅΄ λ°©μ‹ import ν…μ¤νΈ
        from market.coupang.product import ProductClient
        print("β… ProductClient import μ„±κ³µ")
        
        # μƒλ΅μ΄ λ¶„λ¦¬λ ν΄λΌμ΄μ–ΈνΈλ“¤ import ν…μ¤νΈ
        from market.coupang.product import (
            ProductManagementClient,
            ProductQueryClient, 
            VendorItemClient,
            AutoGeneratedOptionClient
        )
        print("β… λ¶„λ¦¬λ ν΄λΌμ΄μ–ΈνΈλ“¤ import μ„±κ³µ")
        
        # μ ν‹Έλ¦¬ν‹° import ν…μ¤νΈ
        from market.coupang.product import (
            setup_project_path,
            print_test_header,
            validate_environment_variables
        )
        print("β… κ³µν†µ μ ν‹Έλ¦¬ν‹° import μ„±κ³µ")
        
        return True
        
    except Exception as e:
        print(f"β Import μ‹¤ν¨: {e}")
        return False


def test_client_initialization():
    """ν΄λΌμ΄μ–ΈνΈ μ΄κΈ°ν™” ν…μ¤νΈ"""
    print("\nπ§ ν΄λΌμ΄μ–ΈνΈ μ΄κΈ°ν™” ν…μ¤νΈ...")
    
    try:
        from market.coupang.product import ProductClient
        
        # λ©”μΈ ν΄λΌμ΄μ–ΈνΈ μ΄κΈ°ν™”
        client = ProductClient()
        print("β… ProductClient μ΄κΈ°ν™” μ„±κ³µ")
        
        # λ‚΄λ¶€ ν΄λΌμ΄μ–ΈνΈλ“¤ ν™•μΈ
        assert hasattr(client, 'product_management'), "product_management μ†μ„±μ΄ μ—†μ"
        assert hasattr(client, 'product_query'), "product_query μ†μ„±μ΄ μ—†μ"
        assert hasattr(client, 'vendor_item'), "vendor_item μ†μ„±μ΄ μ—†μ"
        assert hasattr(client, 'auto_generated_option'), "auto_generated_option μ†μ„±μ΄ μ—†μ"
        print("β… λ‚΄λ¶€ ν΄λΌμ΄μ–ΈνΈλ“¤ μ •μƒ μ΄κΈ°ν™”")
        
        # κΈ°μ΅΄ νΈν™μ„± μ†μ„± ν™•μΈ
        assert hasattr(client, 'BASE_URL'), "BASE_URL μ†μ„±μ΄ μ—†μ"
        assert hasattr(client, 'auth'), "auth μ†μ„±μ΄ μ—†μ"
        print("β… κΈ°μ΅΄ νΈν™μ„± μ†μ„± ν™•μΈ")
        
        return True
        
    except Exception as e:
        print(f"β ν΄λΌμ΄μ–ΈνΈ μ΄κΈ°ν™” μ‹¤ν¨: {e}")
        return False


def test_method_availability():
    """λ©”μ„λ“ κ°€μ©μ„± ν…μ¤νΈ"""
    print("\nπ§ λ©”μ„λ“ κ°€μ©μ„± ν…μ¤νΈ...")
    
    try:
        from market.coupang.product import ProductClient
        client = ProductClient()
        
        # μƒν’ κ΄€λ¦¬ λ©”μ„λ“λ“¤
        product_mgmt_methods = [
            'create_product', 'get_product', 'get_product_partial',
            'update_product', 'update_product_partial', 'request_product_approval',
            'recommend_category'
        ]
        
        for method_name in product_mgmt_methods:
            assert hasattr(client, method_name), f"{method_name} λ©”μ„λ“κ°€ μ—†μ"
        print("β… μƒν’ κ΄€λ¦¬ λ©”μ„λ“λ“¤ ν™•μΈ")
        
        # μƒν’ μ΅°ν λ©”μ„λ“λ“¤
        query_methods = [
            'get_inflow_status', 'list_products', 'get_products_by_time_frame',
            'get_product_status_history', 'get_product_by_external_sku'
        ]
        
        for method_name in query_methods:
            assert hasattr(client, method_name), f"{method_name} λ©”μ„λ“κ°€ μ—†μ"
        print("β… μƒν’ μ΅°ν λ©”μ„λ“λ“¤ ν™•μΈ")
        
        # λ²¤λ”μ•„μ΄ν… κ΄€λ¦¬ λ©”μ„λ“λ“¤
        vendor_item_methods = [
            'get_vendor_item_inventory', 'update_vendor_item_quantity',
            'update_vendor_item_price', 'resume_vendor_item_sales',
            'stop_vendor_item_sales', 'update_vendor_item_original_price'
        ]
        
        for method_name in vendor_item_methods:
            assert hasattr(client, method_name), f"{method_name} λ©”μ„λ“κ°€ μ—†μ"
        print("β… λ²¤λ”μ•„μ΄ν… κ΄€λ¦¬ λ©”μ„λ“λ“¤ ν™•μΈ")
        
        # μλ™μƒμ„±μµμ… λ©”μ„λ“λ“¤
        auto_gen_methods = [
            'enable_vendor_item_auto_generated_option',
            'disable_vendor_item_auto_generated_option',
            'enable_seller_auto_generated_option',
            'disable_seller_auto_generated_option'
        ]
        
        for method_name in auto_gen_methods:
            assert hasattr(client, method_name), f"{method_name} λ©”μ„λ“κ°€ μ—†μ"
        print("β… μλ™μƒμ„±μµμ… λ©”μ„λ“λ“¤ ν™•μΈ")
        
        # κΈ°μ΅΄ νΈν™μ„± λ©”μ„λ“
        assert hasattr(client, '_make_request'), "_make_request λ©”μ„λ“κ°€ μ—†μ"
        print("β… κΈ°μ΅΄ νΈν™μ„± λ©”μ„λ“ ν™•μΈ")
        
        return True
        
    except Exception as e:
        print(f"β λ©”μ„λ“ κ°€μ©μ„± ν…μ¤νΈ μ‹¤ν¨: {e}")
        return False


def test_separated_clients():
    """λ¶„λ¦¬λ ν΄λΌμ΄μ–ΈνΈλ“¤ κ°λ³„ ν…μ¤νΈ"""
    print("\nπ§ λ¶„λ¦¬λ ν΄λΌμ΄μ–ΈνΈλ“¤ κ°λ³„ ν…μ¤νΈ...")
    
    try:
        from market.coupang.product import (
            ProductManagementClient,
            ProductQueryClient,
            VendorItemClient,
            AutoGeneratedOptionClient
        )
        
        # κ° ν΄λΌμ΄μ–ΈνΈ μ΄κΈ°ν™”
        mgmt_client = ProductManagementClient()
        query_client = ProductQueryClient()
        vendor_client = VendorItemClient()
        auto_client = AutoGeneratedOptionClient()
        
        print("β… λ¨λ“  λ¶„λ¦¬λ ν΄λΌμ΄μ–ΈνΈ μ΄κΈ°ν™” μ„±κ³µ")
        
        # κ° ν΄λΌμ΄μ–ΈνΈμ κ³ μ  λ©”μ„λ“ ν™•μΈ
        assert hasattr(mgmt_client, 'create_product'), "create_product λ©”μ„λ“κ°€ μ—†μ"
        assert hasattr(query_client, 'get_inflow_status'), "get_inflow_status λ©”μ„λ“κ°€ μ—†μ"
        assert hasattr(vendor_client, 'update_vendor_item_quantity'), "update_vendor_item_quantity λ©”μ„λ“κ°€ μ—†μ"
        assert hasattr(auto_client, 'enable_vendor_item_auto_generated_option'), "enable_vendor_item_auto_generated_option λ©”μ„λ“κ°€ μ—†μ"
        
        print("β… κ° ν΄λΌμ΄μ–ΈνΈμ κ³ μ  λ©”μ„λ“λ“¤ ν™•μΈ")
        
        return True
        
    except Exception as e:
        print(f"β λ¶„λ¦¬λ ν΄λΌμ΄μ–ΈνΈ ν…μ¤νΈ μ‹¤ν¨: {e}")
        return False


def test_utilities():
    """μ ν‹Έλ¦¬ν‹° ν•¨μλ“¤ ν…μ¤νΈ"""
    print("\nπ§ μ ν‹Έλ¦¬ν‹° ν•¨μλ“¤ ν…μ¤νΈ...")
    
    try:
        from market.coupang.product import (
            setup_project_path,
            format_api_response,
            handle_api_success,
            handle_api_error,
            print_test_header,
            validate_environment_variables
        )
        
        # ν”„λ΅μ νΈ κ²½λ΅ μ„¤μ • ν…μ¤νΈ
        setup_project_path()
        print("β… setup_project_path μ‹¤ν–‰ μ„±κ³µ")
        
        # API μ‘λ‹µ ν¬λ§·ν… ν…μ¤νΈ
        success_response = format_api_response(
            success=True,
            data={"test": "data"},
            message="ν…μ¤νΈ μ„±κ³µ"
        )
        assert success_response["success"] == True
        assert success_response["data"]["test"] == "data"
        print("β… format_api_response μ„±κ³µ μ‘λ‹µ ν…μ¤νΈ")
        
        error_response = format_api_response(
            success=False,
            error="ν…μ¤νΈ μ¤λ¥",
            code="ERROR"
        )
        assert error_response["success"] == False
        assert error_response["error"] == "ν…μ¤νΈ μ¤λ¥"
        print("β… format_api_response μ¤λ¥ μ‘λ‹µ ν…μ¤νΈ")
        
        # ν™κ²½λ³€μ κ²€μ¦ ν…μ¤νΈ
        result = validate_environment_variables("NONEXISTENT_VAR")
        assert result == False  # μ΅΄μ¬ν•μ§€ μ•λ” ν™κ²½λ³€μμ΄λ―€λ΅ False
        print("β… validate_environment_variables ν…μ¤νΈ")
        
        return True
        
    except Exception as e:
        print(f"β μ ν‹Έλ¦¬ν‹° ν…μ¤νΈ μ‹¤ν¨: {e}")
        return False


def main():
    """λ©”μΈ ν…μ¤νΈ μ‹¤ν–‰"""
    print("π€ λ¦¬ν©ν† λ§λ μΏ ν΅ μƒν’ API ν΄λΌμ΄μ–ΈνΈ ν…μ¤νΈ μ‹μ‘")
    print("=" * 80)
    
    tests = [
        ("Import νΈν™μ„±", test_import_compatibility),
        ("ν΄λΌμ΄μ–ΈνΈ μ΄κΈ°ν™”", test_client_initialization),
        ("λ©”μ„λ“ κ°€μ©μ„±", test_method_availability),
        ("λ¶„λ¦¬λ ν΄λΌμ΄μ–ΈνΈλ“¤", test_separated_clients),
        ("μ ν‹Έλ¦¬ν‹° ν•¨μλ“¤", test_utilities)
    ]
    
    passed = 0
    total = len(tests)
    
    for test_name, test_func in tests:
        print(f"\n{'='*60}")
        print(f"π“‹ {test_name} ν…μ¤νΈ")
        print(f"{'='*60}")
        
        try:
            if test_func():
                print(f"β… {test_name} ν…μ¤νΈ ν†µκ³Ό")
                passed += 1
            else:
                print(f"β {test_name} ν…μ¤νΈ μ‹¤ν¨")
        except Exception as e:
            print(f"β {test_name} ν…μ¤νΈ μ¤‘ μμ™Έ λ°μƒ: {e}")
    
    print(f"\n{'='*80}")
    print(f"π‰ ν…μ¤νΈ μ™„λ£: {passed}/{total} ν†µκ³Ό")
    print(f"{'='*80}")
    
    if passed == total:
        print("β… λ¨λ“  ν…μ¤νΈ ν†µκ³Ό! λ¦¬ν©ν† λ§μ΄ μ„±κ³µμ μΌλ΅ μ™„λ£λμ—μµλ‹λ‹¤.")
        
        print(f"\nπ’΅ λ¦¬ν©ν† λ§ κ²°κ³Ό:")
        print("   π”§ λ κ±°μ‹ νμΌ μ κ±° μ™„λ£")
        print("   π“¦ λ¨λ“ν™”λ ν΄λΌμ΄μ–ΈνΈ κµ¬μ΅°")
        print("   π› οΈ κ³µν†µ μ ν‹Έλ¦¬ν‹° μ κ³µ")
        print("   π”„ κΈ°μ΅΄ νΈν™μ„± μ μ§€")
        print("   π“ μ½”λ“ ν’μ§ κ°μ„ ")
        
    else:
        print("β μΌλ¶€ ν…μ¤νΈ μ‹¤ν¨. λ¦¬ν©ν† λ§μ— λ¬Έμ κ°€ μμ„ μ μμµλ‹λ‹¤.")
    
    return passed == total


if __name__ == "__main__":
    success = main()
    sys.exit(0 if success else 1)